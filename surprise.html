<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>生日快乐</title>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&family=Pacifico&display=swap');

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #FEC0CD url('img/background_page2.jpg') no-repeat center center fixed;
      background-size: cover;
      overflow: hidden;
    }

    #confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: none;
    }

    .foto-wrapper {
      position: relative;
      z-index: 2;
      width: 100%;
      display: flex;
      justify-content: center;
      animation: slideDown 2.5s ease-out forwards;
      transform: translateY(-100vh);
    }

    .foto {
      width: 80%;
      max-width: 500px;
      min-width: 300px;
      margin-top: 20px;
    }

    .person-photo,
    .person-photo.cake-photo {
      position: fixed;
      top: 25%;
      left: 50%;
      transform: translateX(-50%);
      width: 360px;
      border-radius: 14px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      z-index: 2;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }

    .person-photo.large {
      width: 360px !important;
    }

    .person-photo.cake-photo {
      top: 25% !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      width: 360px !important;
      bottom: auto !important;
    }

    @keyframes slideDown {
      0% { transform: translateY(-100vh); opacity: 0; }
      50% { opacity: 1; }
      100% { transform: translateY(0); opacity: 1; }
    }

    @media (max-width: 768px) {
      .foto {
        margin-top: 0px;
      }
      .person-photo,
      .person-photo.cake-photo {
        top: 25% !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        width: 240px !important;
        bottom: auto !important;
      }
      .person-photo.large-photo,
      .person-photo.cake-photo.large-photo {
        width: 270px !important;
      }
      .typing-box,
      .typing-box.cake-box {
        bottom: 80% !important;   /* 你觉得哪个值合适就用哪个，比如70%，可调试 */
      }
    }

    .typing-box {
      position: fixed;
      left: 50%;
      top: 3%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.85);
      border-radius: 16px;
      padding: 1rem 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-width: 90vw;    /* 移动端自适应 */
      min-width: 120px;
      width: max-content; /* 关键，让内容撑宽，而不是百分百宽 */
      font-family: 'ZCOOL XiaoWei', 'Pacifico', cursive;
      font-size: 1.2rem;
      color: #333;
      z-index: 5;
      display: none;
      text-align: center;
      animation: fadeIn 1s ease forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -10px); }
      to   { opacity: 1; transform: translate(-50%, 0); }
    }

    .typing-box.invisible {
      display: none !important;
      opacity: 0 !important;
      animation: none !important;
    }

    @keyframes slideCakeUp {
      0% {
        transform: translateX(-50%) translateY(100%);
        opacity: 0;
      }
      100% {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    .person-photo.cake-slide-in {
      animation: slideCakeUp 1s ease-out forwards;
    }

    #typeText {
      font-family: 'Arial', sans-serif;
      font-size: 1.2rem;
      font-style: normal;
      font-weight: bold;
      display: inline-block;
      white-space: nowrap;
      text-align: center;
    }

    body.dark-bg::before {
      content: "";
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      z-index: 0;
      pointer-events: none;
      background: rgba(0,0,0,0.55); /* 暗度可调 */
    }
  </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<img class="person-photo" id="personPhoto" src="img/photo/photo1.jpg" alt="Ta的照片" style="display:none;">

<div class="foto-wrapper">
  <img class="foto" src="img/hbd1.png" alt="生日快乐">
</div>

<div class="typing-box" id="typingBox">
  <p id="typeText"></p>
  <p id="clickTip" style="display:none; margin-top: 1rem; font-size: 1rem; color: #c0392b;">点击照片</p>
</div>

<audio id="birthday-music" src="music/birthday_song.MP3" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script>
  const canvas = document.getElementById('confetti-canvas');
  const confettiInstance = confetti.create(canvas, { resize: true, useWorker: true });

  let isTyping = false;
  let isCakeLit = false;
  let isWishPromptShown = false;
  let isWishMade = false;
  let isCandleBlownOut = false;
  let hasEnteredCakeSequence = false;
  let isClickable = false;
  let canPlayMusic = false; // 🎵 控制音乐播放权限

  function dropConfettiFromTop() {
    const duration = 2000;
    const end = Date.now() + duration;
    const colors = ['#007bff', '#28a745', '#6f42c1', '#fd7e14', '#20c997', '#ffc107'];

    (function frame() {
      confettiInstance({
        particleCount: 10,
        spread: 50,
        startVelocity: 50,
        gravity: 1.6,
        ticks: 200,
        scalar: 1.5,
        colors: colors,
        origin: { x: Math.random(), y: 0 }
      });
      if (Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  function typeWriter(text, elementId, speed, callback) {
    let i = 0;
    const element = document.getElementById(elementId);
    element.textContent = "";
    isTyping = true;
    function type() {
      if (i < text.length) {
        element.textContent += text.charAt(i);
        i++;
        setTimeout(type, speed);
      } else {
        isTyping = false;
        if (typeof callback === 'function') callback();
      }
    }
    type();
  }

  window.onload = () => {
    dropConfettiFromTop();
    setTimeout(() => {
      document.querySelector('.foto-wrapper').style.display = 'none';

      // 让照片出现
      document.getElementById('personPhoto').style.display = 'block';

      canPlayMusic = true; // 🎵 允许播放音乐
      const typingBox = document.getElementById('typingBox');
      typingBox.style.display = 'block';
      typeWriter("听说有人喜欢和姥爷去海底捞，那么！", "typeText", 130, () => {
        setTimeout(() => {
          const typeText = document.getElementById('typeText');
          typeText.textContent = "";

          const tip = document.createElement('span');
          tip.textContent = "点击美女照片！";
          tip.style.fontWeight = 'bold';
          tip.style.fontSize = '1.2rem';
          tip.style.color = '#c0392b';
          typeText.appendChild(tip);

          setTimeout(() => {
            isClickable = true;
          }, 800);
        }, 2000);
      });
    }, 3500);
  };

  // 🎵 用户首次点击才播放生日歌（浏览器允许）
  document.body.addEventListener('click', () => {
    const music = document.getElementById('birthday-music');
    if (canPlayMusic && music.paused) {
      music.play().catch(() => {});
      canPlayMusic = false; // 避免多次触发
    }
  }, { once: true });

  document.getElementById('personPhoto').addEventListener('click', () => {
    if (!isClickable || isTyping) return;

    let photo = document.getElementById('personPhoto');
    const typingBox = document.getElementById('typingBox');
    const typeText = document.getElementById('typeText');
    const clickTip = document.getElementById('clickTip');
    const birthdayMusic = document.getElementById('birthday-music');

    if (photo.src.includes('cake_light.png') && isWishPromptShown && !isCandleBlownOut) {
      isCandleBlownOut = true;
      photo.src = "img/cake/cake_out.png";
      document.body.classList.remove('dark-bg');
      typeText.textContent = "";
      setTimeout(() => {
        const typeText = document.getElementById("typeText");
        typeText.innerHTML = '<span style="color: #e74c3c; font-weight: bold;">愿望已送达 ✨</span>';

        // 5秒后显示新字幕
        setTimeout(() => {
          typeText.innerHTML = '<span>还没结束哦~ 😊</span>';

          const music = document.getElementById('birthday-music');

          function redirectToWish() {
            window.location.href = 'wish.html';
          }

          if (music.ended || music.paused) {
            // 歌曲已结束或没播放，直接跳转
            redirectToWish();
          } else {
            // 歌曲没结束，监听结束后跳转
            music.addEventListener('ended', redirectToWish);
          }
        }, 5000);
      }, 300);
      return;
    }

    if (photo.src.includes('cake_origin.png') && !isCakeLit) {
      isCakeLit = true;
      photo.src = "img/cake/cake_light.png";
      document.body.classList.add('dark-bg');
      typeText.textContent = "";
      clickTip.style.display = 'none';
      typingBox.classList.add('invisible');

      setTimeout(() => {
        typingBox.classList.remove('invisible');
        typingBox.style.display = 'block';
        typeWriter("许个愿吧！", "typeText", 120, () => {
          setTimeout(() => {
            typeText.textContent = "";
            typeWriter("许好愿后点击蜡烛吹灭", "typeText", 100, () => {
              isWishPromptShown = true;
            });
          }, 3000);
        });
      }, 2000);
      return;
    }

    if (isCandleBlownOut) return;

    if (!isCakeLit && !hasEnteredCakeSequence) {
      hasEnteredCakeSequence = true;

      typingBox.style.display = 'none';
      typeText.textContent = '';
      clickTip.style.display = 'none';

      photo.remove(); // ✅ 删除原图片

      const newPhoto = document.createElement('img');
      newPhoto.src = 'img/photo/haidilao.png';
      newPhoto.alt = '海底捞';
      newPhoto.id = 'personPhoto';
      newPhoto.className = 'person-photo cake-photo large-photo';
      newPhoto.style.opacity = '1';
      newPhoto.style.position = 'fixed';
      newPhoto.style.left = '50%';
      newPhoto.style.transform = 'translateX(-50%)';
      newPhoto.style.zIndex = '2';
      newPhoto.style.borderRadius = '14px';
      newPhoto.style.boxShadow = '0 6px 12px rgba(0,0,0,0.3)';
      newPhoto.style.cursor = 'pointer';

      document.body.appendChild(newPhoto);
      photo = newPhoto;

      if (birthdayMusic.paused) birthdayMusic.play().catch(() => {});

      // ✅ 新增：绑定事件
      newPhoto.addEventListener('click', () => {
        if (newPhoto.src.includes('cake_light.png') && isWishPromptShown && !isCandleBlownOut) {
          isCandleBlownOut = true;
          newPhoto.src = "img/cake/cake_out.png";
          document.body.classList.remove('dark-bg');
          typeText.textContent = "";
          setTimeout(() => {
            const typeText = document.getElementById("typeText");
            typeText.innerHTML = '<span style="color: #e74c3c; font-weight: bold;">愿望已送达 ✨</span>';

            // 5秒后显示新字幕
            setTimeout(() => {
              typeText.innerHTML = '<span>还没结束哦~ 😊</span>';

              const music = document.getElementById('birthday-music');

              function redirectToWish() {
                window.location.href = 'wish.html';
              }

              if (music.ended || music.paused) {
                // 歌曲已结束或没播放，直接跳转
                redirectToWish();
              } else {
                // 歌曲没结束，监听结束后跳转
                music.addEventListener('ended', redirectToWish);
              }
            }, 5000);
          }, 300);
          return;
        }

        if (newPhoto.src.includes('cake_origin.png') && !isCakeLit) {
          isCakeLit = true;
          newPhoto.src = "img/cake/cake_light.png";
          document.body.classList.add('dark-bg');
          typeText.textContent = "";
          clickTip.style.display = 'none';
          typingBox.classList.add('invisible');

          setTimeout(() => {
            typingBox.classList.remove('invisible');
            typingBox.style.display = 'block';
            typeWriter("许个愿吧！", "typeText", 120, () => {
              setTimeout(() => {
                typeText.textContent = "";
                typeWriter("许好愿后点击蜡烛吹灭", "typeText", 100, () => {
                  isWishPromptShown = true;
                });
              }, 3000);
            });
          }, 2000);
          return;
        }
      });

      setTimeout(() => {
        if (isCakeLit) return;

        typingBox.classList.add('cake-box');
        typingBox.style.display = 'block';

        typeWriter("上蛋糕！", "typeText", 150, () => {
          photo.style.display = 'none';

          setTimeout(() => {
            photo.src = 'img/cake/cake_origin.png';
            photo.classList.add('cake-photo', 'cake-slide-in', 'large-photo');
            photo.style.display = 'block';

            setTimeout(() => {
              typeText.textContent = "";
              typeWriter("Happy Birthday to 竹竹!", "typeText", 100, () => {
                setTimeout(() => {
                  typeText.textContent = "";
                  typeText.innerHTML = `<span>点击星星蜡烛点燃 🔥</span>`;
                  typeText.style.display = 'flex';
                  typeText.style.alignItems = 'center';
                  typeText.style.justifyContent = 'center';
                  typeText.style.gap = '0.5rem';
                  typeText.style.fontSize = '1.2rem';
                  typeText.style.fontWeight = 'bold';
                  typeText.style.color = '#e67e22';
                }, 2000);
              });
            }, 1000);
          }, 400);
        });
      }, 5000);
    }
  });
</script>
</body>
</html>
